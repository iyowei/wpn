# wpn-zip-handler.sh 使用指南

## 功能说明

`wpn-zip-handler.sh` 是一个用于处理 WireGuard VPN 项目压缩包的自动化脚本。主要功能包括：

1. **自动发现**：检索执行目录中所有 `wpn-*.zip` 格式的压缩包
2. **安全解压**：将压缩包解压到对应目录（去掉 .zip 后缀）
3. **权限设置**：自动为解压后的所有 shell 脚本（.sh 文件）设置可执行权限
4. **日志管理**：自动记录操作日志并清理 7 天前的旧日志

## 系统要求

### 依赖工具
- `bash` (v3.2+)
- `unzip` - 解压缩工具
- `find` - 文件查找工具
- `date` - 日期时间工具

### 测试环境
- macOS (已测试)
- Ubuntu 24 LTS (目标平台)

## 使用方法

### 基本用法

```bash
# 在包含 wpn-*.zip 文件的目录执行
cd /path/to/project
./scripts/wpn-zip-handler.sh
```

### 执行权限设置

首次使用前需要为脚本设置执行权限：

```bash
chmod +x scripts/wpn-zip-handler.sh
```

## 工作原理

1. **日志初始化**
   - 在执行目录创建 `logs` 目录
   - 生成格式为 `wpn-zip-handler-YYYYMMDD-HHMMSS.log` 的日志文件

2. **日志轮转**
   - 自动清理超过 7 天的旧日志文件
   - 每次执行前进行清理

3. **压缩包处理**
   - 搜索当前目录下所有 `wpn-*.zip` 文件
   - 使用临时目录进行安全解压
   - 解压完成后移动到最终目录

4. **权限设置**
   - 递归查找解压目录中的所有 `.sh` 文件
   - 批量设置可执行权限（chmod +x）

## 输出示例

### 成功处理压缩包

```
===============================================
2025-08-29 17:14:05 wpn-zip-handler v1.0.0 开始执行
2025-08-29 17:14:05 工作目录: /Users/iyowei/self/development/wpn
2025-08-29 17:14:05 日志文件: /Users/iyowei/self/development/wpn/logs/wpn-zip-handler-20250829-171405.log
===============================================
2025-08-29 17:14:05 开始日志轮转，清理 7 天前的日志...
2025-08-29 17:14:05 已清理 1 个旧日志文件
2025-08-29 17:14:05 正在搜索 wpn-*.zip 压缩包...
2025-08-29 17:14:05 找到 1 个压缩包:
  - wpn-20250829-144131.zip
2025-08-29 17:14:05 正在设置 shell 脚本执行权限...
  [✓] scripts/server-reboot.sh
  [✓] scripts/wireguard-healthcheck.sh
  [✓] scripts/install-cron.sh
  [✓] scripts/notification.sh
  [✓] scripts/dns-refresh.sh
  [✓] scripts/log-rotation.sh
2025-08-29 17:14:05 共设置 6 个 shell 脚本可执行权限

2025-08-29 17:14:05 ===== 处理结果汇总 =====
2025-08-29 17:14:05 成功处理: 1 个压缩包

2025-08-29 17:14:05 wpn-zip-handler 执行成功完成
===============================================
```

### 无压缩包时

```
2025-08-29 17:13:21 未找到任何 wpn-*.zip 压缩包
2025-08-29 17:13:21 没有需要处理的压缩包，脚本退出
```

### 目标目录已存在

```
2025-08-29 17:13:11 警告: 目标目录已存在: /path/to/wpn-20250829-144131
2025-08-29 17:13:11 跳过此压缩包的解压
```

## 错误处理

脚本包含完善的错误处理机制：

- **压缩包损坏**：记录错误并继续处理其他文件
- **目录已存在**：跳过该压缩包，避免覆盖
- **权限不足**：记录失败的文件并继续处理
- **异常退出**：自动清理临时文件

## 集成建议

### Makefile 集成

可以在项目的 Makefile 中添加目标：

```makefile
# 解压并设置权限
unpack:
	@./scripts/wpn-zip-handler.sh
```

### 定时任务集成

如需定时处理，建议添加文件锁机制避免并发执行：

```bash
#!/bin/bash
LOCKFILE="/var/lock/wpn-zip-handler.lock"

(
  flock -n 200 || { echo "另一个实例正在运行"; exit 1; }
  /path/to/scripts/wpn-zip-handler.sh
) 200>"$LOCKFILE"
```

## 注意事项

1. **工作目录**：脚本在当前工作目录（PWD）执行，而非脚本所在目录
2. **命名规范**：只处理 `wpn-*.zip` 格式的压缩包
3. **目录冲突**：如果解压目标目录已存在，将跳过处理
4. **日志存储**：日志文件保存在执行目录的 `logs` 子目录中

## 版本信息

- 版本：1.0.0
- 作者：WPN 项目组
- 许可：项目内部使用

## 故障排查

### 常见问题

1. **找不到 mapfile 命令**
   - 原因：旧版 bash 不支持
   - 解决：脚本已使用 while read 循环替代

2. **realpath 命令不存在**
   - 原因：macOS 默认未安装
   - 解决：脚本已使用字符串操作替代

3. **权限被拒绝**
   - 原因：脚本无执行权限
   - 解决：`chmod +x scripts/wpn-zip-handler.sh`

### 调试模式

如需调试，可以修改脚本开头添加：

```bash
set -xeuo pipefail  # 添加 -x 开启调试输出
```

## 更新日志

### v1.0.0 (2025-08-29)
- 初始版本发布
- 支持批量解压 wpn-*.zip 文件
- 自动设置 shell 脚本执行权限
- 实现日志轮转机制
- 兼容 macOS 和 Ubuntu 24 LTS
